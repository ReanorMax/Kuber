# Диаграмма архитектуры Kubernetes кластера

## Общая схема архитектуры

```
                    ┌─────────────────────────────────────────────┐
                    │              External Access                │
                    │                                             │
    Browser ────────┼─► http://grafana.local (Ingress)           │
    Browser ────────┼─► http://192.168.49.2:31282 (NodePort)     │
    kubectl ────────┼─► port-forward to Prometheus/Alertmanager  │
                    └─────────────────────────────────────────────┘
                                           │
                    ┌─────────────────────────────────────────────┐
                    │           Minikube Node (192.168.49.2)      │
                    │                                             │
                    │  ┌─────────────────────────────────────────┐│
                    │  │         Control Plane                   ││
                    │  │  ┌─────────┐  ┌─────────┐  ┌─────────┐ ││
                    │  │  │API Srv  │  │  etcd   │  │Scheduler│ ││
                    │  │  │ :8443   │  │ (store) │  │         │ ││
                    │  │  └─────────┘  └─────────┘  └─────────┘ ││
                    │  │  ┌─────────┐               ┌─────────┐ ││
                    │  │  │Ctrl Mgr │               │CoreDNS  │ ││
                    │  │  │         │               │ :53     │ ││
                    │  │  └─────────┘               └─────────┘ ││
                    │  └─────────────────────────────────────────┘│
                    │                      │                      │
                    │  ┌─────────────────────────────────────────┐│
                    │  │          Node Components                ││
                    │  │  ┌─────────┐  ┌─────────┐  ┌─────────┐ ││
                    │  │  │ kubelet │  │kube-proxy│  │ Docker  │ ││
                    │  │  │         │  │ (iptbls)│  │ Runtime │ ││
                    │  │  └─────────┘  └─────────┘  └─────────┘ ││
                    │  └─────────────────────────────────────────┘│
                    │                      │                      │
                    │  ┌─────────────────────────────────────────┐│
                    │  │           Application Pods              ││
                    │  │                                         ││
                    │  │  ┌─────────────────────────────────────┐││
                    │  │  │        Monitoring Namespace        │││
                    │  │  │  ┌─────────┐  ┌─────────┐          │││
                    │  │  │  │Prometheus│  │ Grafana │          │││
                    │  │  │  │StatefulSt│  │Deployment│          │││
                    │  │  │  │  :9090   │  │  :3000  │          │││
                    │  │  │  └─────────┘  └─────────┘          │││
                    │  │  │  ┌─────────┐  ┌─────────┐          │││
                    │  │  │  │AlertMngr │  │Kube-state│         │││
                    │  │  │  │StatefulSt│  │ Metrics │          │││
                    │  │  │  │  :9093   │  │  :8080  │          │││
                    │  │  │  └─────────┘  └─────────┘          │││
                    │  │  │  ┌─────────┐                      │││
                    │  │  │  │Node Exp │ ← DaemonSet          │││
                    │  │  │  │  :9100  │   (on every node)    │││
                    │  │  │  └─────────┘                      │││
                    │  │  └─────────────────────────────────────┘││
                    │  │                                         ││
                    │  │  ┌─────────────────────────────────────┐││
                    │  │  │      Ingress-nginx Namespace       │││
                    │  │  │  ┌─────────┐                       │││
                    │  │  │  │ Nginx   │ ← Ingress Controller  │││
                    │  │  │  │Ingress  │   (routes traffic)    │││
                    │  │  │  │  :80/:443│                      │││
                    │  │  │  └─────────┘                       │││
                    │  │  └─────────────────────────────────────┘││
                    │  └─────────────────────────────────────────┘│
                    └─────────────────────────────────────────────┘
```

## Сетевая схема и Service Discovery

```
┌────────────────────────────────────────────────────────────────────────┐
│                          Service Layer                                 │
│                                                                        │
│  ┌──────────────┐    ┌──────────────┐    ┌──────────────┐            │
│  │   ClusterIP  │    │   NodePort   │    │   Ingress    │            │
│  │   Services   │    │   Services   │    │    Rules     │            │
│  │              │    │              │    │              │            │
│  │ prometheus   │    │ grafana      │    │grafana.local │            │
│  │ :9090        │    │ :31282       │    │ -> grafana:80│            │
│  │              │    │              │    │              │            │
│  │ alertmanager │    │ ingress-nginx│    │ (planned:    │            │
│  │ :9093        │    │ :30258/:32605│    │ prometheus   │            │
│  │              │    │              │    │ .local)      │            │
│  └──────────────┘    └──────────────┘    └──────────────┘            │
└────────────────────────────────────────────────────────────────────────┘
                                │
┌────────────────────────────────────────────────────────────────────────┐
│                         Pod Network                                    │
│                    (CNI: bridge/veth)                                  │
│                                                                        │
│  Pod IP Range: 10.244.0.0/24 (Minikube default)                      │
│                                                                        │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  │
│  │ Prometheus  │  │   Grafana   │  │ Alertmanager│  │   Nginx     │  │
│  │ 10.244.0.x  │  │ 10.244.0.13 │  │ 10.244.0.x  │  │ 10.244.0.x  │  │
│  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘  │
│                                                                        │
│  ┌─────────────┐  ┌─────────────┐                                     │
│  │kube-state   │  │Node Exporter│                                     │
│  │ 10.244.0.x  │  │ 10.244.0.x  │                                     │
│  └─────────────┘  └─────────────┘                                     │
└────────────────────────────────────────────────────────────────────────┘
```

## Схема мониторинга и сбора метрик

```
                    ┌─────────────────────────────────────────┐
                    │              Data Sources               │
                    └─────────────────┬───────────────────────┘
                                      │
    ┌─────────────┐    ┌─────────────┐│┌─────────────┐    ┌─────────────┐
    │   kubelet   │    │kube-state   │││Node Exporter│    │  API Server │
    │   metrics   │    │  metrics    │││  (host)     │    │   metrics   │
    │   :10250    │    │   :8080     │││   :9100     │    │   :8443     │
    └─────────────┘    └─────────────┘│└─────────────┘    └─────────────┘
            │                  │      │        │                  │
            │     ┌────────────┴──────┼────────┴──────────────────┘
            │     │                   │                │
            │     │    ┌──────────────▼────────────────▼──┐
            │     │    │          Prometheus              │
            │     │    │       (Service Discovery)        │
            │     │    │      scrapes every 30s           │
            │     │    │          :9090                   │
            │     │    └──────────────┬───────────────────┘
            │     │                   │                │
            └─────┼───────────────────┼────────────────┘
                  │                   │    
    ┌─────────────▼─┐         ┌─────▼────────┐      ┌─────────────┐
    │   Grafana     │         │ Alertmanager │      │   Storage   │
    │ (Visualiz.)   │         │  (Alerts)    │      │ (PersistVol)│
    │    :3000      │         │    :9093     │      │             │
    └───────────────┘         └──────────────┘      └─────────────┘
            │
    ┌───────▼────────┐
    │   Dashboard    │
    │   (Browser)    │
    └────────────────┘
```

## Схема развертывания Helm

```
    ┌─────────────┐
    │    Helm     │
    │   Client    │
    └─────────────┘
            │
            │ helm install prometheus 
            │ kube-prometheus-stack
            │
            ▼
    ┌─────────────┐      ┌─────────────────────────────────────┐
    │ Helm Chart  │ ───► │         Generated Resources         │
    │ Repository  │      │                                     │
    │             │      │ • Prometheus Operator (Deployment) │
    │kube-prometheus      │ • Prometheus Server (StatefulSet)  │
    │    -stack    │      │ • Grafana (Deployment)            │
    │             │      │ • Alertmanager (StatefulSet)      │
    └─────────────┘      │ • ServiceMonitors (CRDs)          │
                         │ • PrometheusRules (CRDs)          │
                         │ • Services, ConfigMaps, etc.       │
                         └─────────────────────────────────────┘
                                         │
                                         ▼
                         ┌─────────────────────────────────────┐
                         │         Kubernetes Cluster         │
                         │                                     │
                         │     monitoring namespace           │
                         └─────────────────────────────────────┘
```

## Текущие проблемы с доступом

```
┌─────────────────┐    ❌ No Ingress     ┌─────────────────┐
│   Prometheus    │ ◄──────────────────► │   External      │
│     :9090       │    port-forward      │   Access        │
└─────────────────┘    kubectl only      └─────────────────┘

┌─────────────────┐    ❌ No Ingress     
│  Alertmanager   │ ◄──────────────────► 
│     :9093       │    port-forward      
└─────────────────┘    kubectl only      

┌─────────────────┐    ✅ Has Ingress    ┌─────────────────┐
│    Grafana      │ ◄──────────────────► │ grafana.local   │
│     :3000       │    + NodePort        │ + :31282        │
└─────────────────┘    both work         └─────────────────┘
```

## Планируемые улучшения

```
                         ┌─────────────────────────────────────┐
                         │         Target Architecture         │
                         │                                     │
    Browser ────────────►│  https://grafana.local    (SSL)    │
    Browser ────────────►│  https://prometheus.local (SSL)    │
    Browser ────────────►│  https://alertmanager.local (SSL)  │
                         │                                     │
                         │  All through Ingress + TLS         │
                         │  No more port-forward needed        │
                         └─────────────────────────────────────┘
```
